name: .NET

on:
    push:
        branches:
            - main
            - release
    pull_request:
        branches:
            - '**'

env:
    USE_FULL_NUMERIC_PROVIDER: "true"
    MSBUILDDISABLENODEREUSE: "1"
    # Force single MSBuild worker to reduce crash risk
    DOTNET_CLI_TELEMETRY_OPTOUT: "1"

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v4

            -   name: Setup .NET
                uses: actions/setup-dotnet@v4
                with:
                    global-json-file: global.json

            -   name: Restore dependencies
                run: |
                    dotnet restore --configuration Release

            -   name: Build
                run: |
                    dotnet build --configuration Release --no-restore \
                      -maxcpucount:1 /nodeReuse:false

            -   name: Test
                run: |
                    dotnet test --configuration Release --no-build \
                      --verbosity minimal \
                      --results-directory ./TestResults \
                      --logger "trx;LogFileName=test_results.trx"

            -   name: Upload test results
                uses: actions/upload-artifact@v4
                if: always()
                with:
                    name: test-results
                    path: ./TestResults
